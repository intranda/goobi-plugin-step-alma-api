<config_plugin>
    <!--
        order of configuration is:
          1.) project name and step name matches
          2.) step name matches and project is *
          3.) project name matches and step name is *
          4.) project name and step name are *
	-->
    
    <config>
        <!-- which projects to use for (can be more then one, otherwise use *) -->
        <project>*</project>
        <step>*</step>
        
        <!-- Base URL -->
        <url>https://api-eu.hosted.exlibrisgroup.com</url>
        
        <!-- API key -->
        <api-key>CHANGE_ME</api-key>
        
        <!-- Variables that can be used for following commands.
              @name: name of the variable, e.g. VARIABLE. To use this variable's value, one can simply use {$VARIABLE}.
              @value: value to initialize this variable. It can be plain string value, or a Goobi variable, e.g. {meta.NAME} for a Metadata named NAME.
         -->
        <variable name="MMS_ID" value="{meta.RezenssionsZssDBID}" />
        <!-- There can be multiple variables defined before all commands. -->
        <variable name="SIGNATURE" value="{meta.shelfmarksource}" />
        
        <!-- A command is a step to perform. There can be several commands configured, and if so, they will be run one by one in the same order as they are defined. 
              @method: get | put | post | patch
              @accept: json | xml. Used to set up the header parameter 'Accept'. OPTIONAL. DEFAULT json.
              @content-type: json | xml. Used to set up the header parameter 'Content-type'. OPTIONAL. DEFAULT json.
              @endpoint: raw endpoint string without replacing the placeholders enclosed by {}. For every placeholder say {PLACEHOLDER}, one has to configure it in a 
                                sub-tag, and in our example it would be <PLACEHOLDER>. Options for values of these sub-tags are:
                                - plain text value 
                                - any variable defined by a <variable> tag before all <command> blocks
                                - any variable defined by a <target> sub-tag of any previous <command> block
        -->     
        <command method="get" accept="json" content-type="json" endpoint="/almaws/v1/bibs/{mms_id}/holdings/ALL/items">
        	<!-- define the value of the placeholder {mms_id} using the variable named MMS_ID -->
        	<mms_id>{$MMS_ID}</mms_id>
        	
        	<!-- Filter condition that is to be applied on the REST call response. OPTIONAL.
        	      ATTENTION: to use this tag, one has to assure that the @accept configured in the command tag is json.
        	      @key: JSON path from which the values are to be fetched for the filtering process
        	      @fallback: JSON path that shall be used when the JSON path configured by @key contains no value. OPTIONAL.
        	      @value: value to be compared with, which can be a plain text value, or a variable defined previously in the format {$VARIABLE}
        	      @alt: alternative option if there is no match found. Options are: all | first | last | random | none. OPTIONAL.
        	              - all: filter nothing out, search the whole JSONObject for the following targets
        	              - first: get the first JSONObject related to the common heading path shared by filter and targets, and search for targets within it
        	              - last: get the last JSONObject related to the common heading path shared by filter and targets, and search for targets within it
        	              - random: get a random JSONObject related to the common heading path shared by filter and targets, and search for targets within it
        	              - none: filter everything out and stop searching. DEFAULT.
        	 -->
        	<filter key="item.item_data.alternative_call_number" fallback="item.holding_data.permanent_call_number" value="{$SIGNATURE}" alt="all" />
        	
        	<!-- Target values that is to be retrieved from the REST call response and saved as a variable. OPTIONAL. 
        	       ATTENTION: to use this tag, one has to assure that the @accept configured in the command tag is json.
        	      @var: name of the variable that is to be used to save the target values retrieved. 
        	                If the variable was already defined before, then its value will be updated. Otherwise a new variable under this name will be created. 
        	      @path: JSON path from where values are to be retrieved.
        	 -->
        	<target var="ITEM_PID" path="item.item_data.pid" />
        	
        	<!-- There can be multiple targets configured. -->
        	<!-- In this example, the new variable will be named HOLDING_ID and it can be reused in the following steps using {$HOLDING_ID}. -->
        	<target var="HOLDING_ID" path="item.holding_data.holding_id" />
        </command>
        
        <!-- use default settings of @accept and @content-type, which are both json -->
        <command method ="post" endpoint="/almaws/v1/bibs/{mms_id}/holdings/{holding_id}/items/{item_pid}">
        	<!-- define the value of the placeholder {mms_id} using the variable named MMS_ID -->
        	<mms_id>{$MMS_ID}</mms_id>
        	<!-- define the value of the placeholder {holding_id} using the variable named HOLDING_ID -->
        	<holding_id>{$HOLDING_ID}</holding_id>
        	<!-- define the value of the placeholder {item_pid} using the variable named ITEM_PID -->
        	<item_pid>{$ITEM_PID}</item_pid>
        	
            <!-- A parameter tag can be used to define parameters that shall be sent by the REST request. There can be multiple parameters configured.
                  @name: parameter name
                  @value: parameter value, which can only be plain text values here
             -->
        	<parameter name="op" value="scan" />
        	<parameter name="library" value="" />
        	<parameter name="department" value="InDigiZ_Dep" />
        	<parameter name="work_order_type" value="InDigiZ" />
        	<parameter name="done" value="false" />
        </command>
        
        <!-- use default settings of @accept and @content-type, which are both json -->
        <command method="post" endpoint="/almaws/v1/bibs/{mms_id}/holdings/{holding_id}/items/{item_pid}">
        	<mms_id>{$MMS_ID}</mms_id>
        	<holding_id>{$HOLDING_ID}</holding_id>
        	<item_pid>{$ITEM_PID}</item_pid>
        	
        	<parameter name="op" value="scan" />
        	<parameter name="library" value="" />
        	<parameter name="department" value="InDigiZ_Dep" />
        	<parameter name="work_order_type" value="InDigiZ" />
        	<parameter name="done" value="true" />
        </command>
        
        <!-- use default settings of @accept and @content-type, which are both json -->
        <command method="post" endpoint="/almaws/v1/bibs/{mms_id}/holdings/{holding_id}/items/{item_pid}">
        	<mms_id>{$MMS_ID}</mms_id>
        	<holding_id>{$HOLDING_ID}</holding_id>
        	<item_pid>{$ITEM_PID}</item_pid>
        	
        	<parameter name="op" value="scan" />
        	<parameter name="library" value="Z01" />
        	<parameter name="circ_desk" value="DEFAULT_CIRC_DESK" />
        </command>
        
        <!-- A save tag is used to define an entry that is to be saved after running all previous commands. OPTIONAL.
              @type: type of the entry, OPTIONS are property | metadata
                         - property: save the entry as a process property
                         - metadata: save the entry as a metadata
              @name: name of the entry, which means
                           - property name if @type is "property"
                           - metadata type name if @type is "metadata"
              @value: value of the new process property, possible values are
                           - a plain text value
                           - a variable defined before all <command> blocks via a <variable> tag
                           - a variable defined within some <command> block via a <target> tag
              @choice: indicates how many items should be saved into this new property, OPTIONS are first | last | all | random.
                            - first: save only the first one among all retrieved values
                            - last: save only the last one among all retrieved values
                            - random: save a random one from all retrieved values
                            - all: join all retrieved values to formulate a single string separated by commas and save it. DEFAULT. 
              @overwrite: true if the old property named so should be reused, false if a new property should be created, DEFAULT false.
        -->     
        <save type="property" name="holding_id" value="{$HOLDING_ID}" choice="first" overwrite="true" />
        <!-- There can be multiple save tags configured. -->
        <save type="property" name="item_pid" value="{$ITEM_PID}" choice="first" overwrite="true" />
        <save type="metadata" name="CatalogIDDigital" value="{$MMS_ID}" choice="first" overwrite="true" />
    </config>
    
    <config>
        <!-- which projects to use for (can be more then one, otherwise use *) -->
        <project>*</project>
        <step>upload marc and portfolio</step>
        
        <!-- Base URL -->
        <url>https://api-eu.hosted.exlibrisgroup.com</url>
        
        <!-- API key -->
        <api-key>CHANGE_ME</api-key>
        
        <variable name="MARC_FOLDER" value="/opt/digiverso/goobi/marcexport/{processid}" />
        <variable name="PORTFOLIO_PATH" value="/opt/digiverso/import/portfolio.xml" />
        
        <command method="post" accept="json" content-type="xml" endpoint="/almaws/v1/bibs">
            <parameter name="normalization" value="43588" />
            <parameter name="validate" value="false" />
            <parameter name="override_warning" value="true" />
            <parameter name="check_match" value="false" />
        	
            <!-- Set up request body. OPTIONAL.
                 @src: absolute path to the file whose contents shall be used as request body. OPTIONAL. It accepts one of the following both:
                          - a plain text value stating the absolute path
                          - a predefined variable containing the absolute path
                          ATTENTION: one can also use the absolute path of the folder containing this file here, in which case the content of the first file in that folder will be used.
                 @wrapper: wrappers separated by space that shall be wrapped around the content read from the file. ONLY applicable if @src is configured. OPTIONAL.
                                  The precise way of wrapping depends on the setting of @content-type of the command tag.
                                  For example, say one has wrapper configured as "wrapper1 wrapper2 wrapper3" then:
                                  - If @content-type="json", the file content will be wrapped as {wrapper1: {wrapper2: {wrapper3: {FILE_CONTENT}}}} 
                                  - If @content-type="xml", the file content will be wrapped as <wrapper1><wrapper2><wrapper3>{FILE_CONTENT}</wrapper3></wrapper2></wrapper1>
                 @value: use a plain text value or a predefined variable instead of the content of a file. OPTIONAL. ATTENTION:
                              - to use a plain text value one has to assure that its format matches the configured @content-type correctly
                              - to use a variable one has to assure that the format of the variable's value matches the configured @content-type correctly
              -->
            <body src="{$MARC_FOLDER}" wrapper="bib" />
        	
            <target var="MMS_ID" path="mms_id" />
        </command>
        
        <command method="post" accept="xml" content-type="xml" endpoint="/almaws/v1/bibs/{mms_id}/portfolios">
            <mms_id>{$MMS_ID}</mms_id>
            <!-- use content of the file as request body, no wrapper needed -->
            <body src="{$PORTFOLIO_PATH}" wrapper="" />
            <!-- create a new variable to hold the value on this JSON path  -->
            <target var="PORTFOLIO_ID" path="electronic_collection.id.value" />         
        </command>       
        
        <!-- save values of variables as process properties  -->
        <save type="property" name="mms_id" value="{$MMS_ID}" choice="first" overwrite="true" />
        <save type="property" name="portfolio_id" value="{$PORTFOLIO_ID}" choice="first" overwrite="true" />
    </config>
    
    <config>
        <!-- which projects to use for (can be more then one, otherwise use *) -->
        <project>*</project>
        <step>update portfolio</step>
        
        <!-- Base URL -->
        <url>https://api-eu.hosted.exlibrisgroup.com</url>
        
        <!-- API key -->
        <api-key>CHANGE_ME</api-key>
        
        <!-- create variables using values read from process properties -->
        <variable name="MMS_ID" value="{process.mms_id}" />
        <variable name="PORTFOLIO_ID" value="{process.portfolio_id}" />
        
        <command method="get" accept="json" content-type="json" endpoint="/almaws/v1/bibs/{mms_id}/portfolios/{portfolio_id}">
            <!-- define the value of the placeholder {mms_id} using the value of the variable named MMS_ID -->
            <mms_id>{$MMS_ID}</mms_id>
            <!-- define the value of the placeholder {portfolio_id} using the value of the variable named PORTFOLIO_ID -->
            <portfolio_id>{$PORTFOLIO_ID}</portfolio_id>      
            	
            <!-- An update tag is used to save the MAYBE updated response JSONObject as an variable. AT MOST ONE allowed. OPTIONAL.
                   ATTENTION: to use this tag, one has to assure that the @accept configured in the command tag is json.
                   @var: name of the variable that shall be used to save the JSONObject.
               -->
            <update var="UPDATED_PORTFOLIO" >
                <!-- An entry tag is used to define modifications that shall be made on the response JSONObject. OPTIONAL. 
                       @path: JSON path(s) of the item(s) that shall be modified, where plural comes into use when there is a JSONArray with multiple elements mixed in this JSON path
                       @value: new value of the item(s) selected by the JSON path
                    -->
                <entry path="availability.value" value="10" />
                <!-- There can be multiple entry sub-tags configured under the update tag. Entry updates will be done one by one. -->
                <entry path="coverage_details.coverage_in_use.value" value="0" />
            </update>
        </command>
        
        <!-- use default settings of @accept and @content-type, which are both json -->
        <command method="put" endpoint="/almaws/v1/bibs/{mms_id}/portfolios/{portfolio_id}">
            <mms_id>{$MMS_ID}</mms_id>
            <portfolio_id>{$PORTFOLIO_ID}</portfolio_id>        
            <!-- use the JSONObject saved by the last command as the request body --> 	
            <body value="{$UPDATED_PORTFOLIO}" />        	
        </command>                     
    </config>

</config_plugin>